---
title: "psychencode_models_cleaned"
author: "Daniel Kiss"
date: "7/3/2023"
output: html_document
---
Packages etc.
```{r}
library(dplyr)
library(tidyverse)
library(edgeR)
library(markerGeneProfile) 
library(matrixStats)
library(cowplot)
library(broom)
library(knitr)
library(ggpubr)
library(biomaRt)
library(ggrepel)
library(patchwork)
library(ggsignif)
library(modelr)
library(ggbeeswarm)
library(lemon)
theme_set(theme_classic2())
#Colour palette
cbPalette = c("#56B4E9", "#009E73","#E69F00", "#0072B2", "#D55E00", "#CC79A7","#000000","#F0E442")
```

Loading Data
```{r}
#Metadata for individual cohorts + Psychencode -> Merge for ease of access
GVEX_metadata = read.delim("/external/rprshnas01/external_data/psychencode/PsychENCODE/BrainGVEX/RNAseq/SYNAPSE_METADATA_MANIFEST.tsv") %>% subset(dataType == "geneExpression") #%>% select(specimenID, PMI, hemisphere, pH, BrodmannArea, RIN)
LIBD_metadata = read.delim("/external/rprshnas01/external_data/psychencode/PsychENCODE/LIBD__szControl/RNAseq/SYNAPSE_METADATA_MANIFEST.tsv") %>% subset(dataType == "geneExpression") 
CMC_metadata = read.delim("/external/rprshnas01/external_data/psychencode/PsychENCODE/CMC/Metadata/SYNAPSE_METADATA_MANIFEST.tsv") %>% subset(dataType == "geneExpression")
psychencode_metadata = read.csv(("/external/rprshnas01/external_data/psychencode/PsychENCODE/Metadata/CapstoneCollection_Metadata_Clinical.csv"))
GVEX_metadata = GVEX_metadata %>% inner_join(psychencode_metadata)
LIBD_metadata = LIBD_metadata %>% inner_join(psychencode_metadata)
CMC_metadata = CMC_metadata %>% inner_join(psychencode_metadata)

#Cell type proportions for each data set merged with metadata - ready for modelling 
gvex_estimations = read.csv("/external/rprshnas01/kcni/dkiss/cell_prop_psychiatry/data/gvex_cell_prop.csv")
gvex_estimations$dataset = rep("GVEX", nrow(gvex_estimations))
libd_estimations = read.csv("/external/rprshnas01/kcni/dkiss/cell_prop_psychiatry/data/libd_cell_prop.csv")
libd_estimations$dataset = rep("LIBD", nrow(libd_estimations))
libd_estimations[which(is.na(libd_estimations$individualIdSource)), 'individualIdSource'] = 'LIBD_szControl'
cmc_estimations = read.csv("/external/rprshnas01/kcni/dkiss/cell_prop_psychiatry/data/cmc_cell_prop.csv")
cmc_estimations$dataset = rep("CMC", nrow(cmc_estimations))

#Load single cell samples 
psychencode_snCTPs = read_csv('/external/rprshnas01/netdata_kcni/stlab/cross_cohort_MGPs/psychencode_snCTPs.csv') 
```

Combine all MGP data into a single df
```{r}
all_estimations = bind_rows(bind_rows(gvex_estimations, libd_estimations), cmc_estimations)
all_estimations$primaryDiagnosis = factor(all_estimations$primaryDiagnosis, levels =c('control', "Schizophrenia", "Bipolar Disorder"))
all_estimations = all_estimations %>% filter(!is.na(individualIdSource), !is.na(primaryDiagnosis),individualIdSource != 'BSHRI', ageDeath >= 15)

#It appears that SMRI cohorts have very few subjects after filtering. Create a new column (new_study) that collapses SMRI cohorts back into GVEX, whilst keeping all other cohorts on their own. 
new_study = all_estimations$individualIdSource 
new_study[grepl("SMRI", new_study)] = "GVEX"
all_estimations$newStudy = new_study %>% factor(levels = c("GVEX", "NIMH_HBCC","Pitt", "LIBD_szControl", "MSSM", "Penn"))

#all_estimations = all_estimations %>% mutate(individualIdSource = recode(individualID, NA ="LIBD"))
all_estimations_long = all_estimations %>% pivot_longer(cols = Astrocyte:VLMC, names_to = 'cell_type', values_to = 'rel_prop') 
  
```


Model cell type proportion based on psychiatric diagnosis
```{r}
combined_lms = all_estimations_long %>% filter(primaryDiagnosis %in% c('Schizophrenia', "control")) %>%
  # group stacked data by cell_type
  group_by(newStudy, cell_type) %>%
  # fit all the cell_type_prop data according to the model
  # using the broom package to tidy the results
  do(tidy(lm(scale(rel_prop) ~ scale(RIN) + scale(ageDeath) + scale(PMI) +
               reportedGender + primaryDiagnosis, data = .))) %>%
  # unstack the data and adjust for multiple comparisons using the Benjamini-Hochberg method
  ungroup() %>%
  mutate(padj = p.adjust(p.value, method = 'fdr')) %>%
  # add cell class labels
  mutate(class = case_when(
    str_detect(cell_type, "Inh") ~ "Inhibitory",
    str_detect(cell_type, "Exc") ~ "Excitatory",
    TRUE ~ "Non-Neuronal")) %>%
  # clean up the names in the term column
  mutate(term = recode(term,
                       `(Intercept)` = "Intercept",
                       `reportedGendermale` = "gender:Male",
                       `primaryDiagnosisSchizophrenia` = "SCZ",
                       `primaryDiagnosisBipolar Disorder` = "BP",
                       `DxMDD` = "MDD",
                       `scale(ageDeath)` = "Age",
                       `scale(PMI..in.hours.)` = "PMI",
                       `scale(RIN)` = "RIN")) %>%
  # merge with unique study information
  merge(unique(all_estimations_long[c('dataset', 'newStudy')]), by.x = "newStudy") %>%
  mutate(newStudy = factor(newStudy, levels = c("Pitt", "GVEX", "NIMH_HBCC", "LIBD_szControl", "MSSM", "Penn")))
```


Interaction Models: As outlined above, there appears to be an interaction between age x diagnosis with respect to SST cell proportion. In other words, SST cell proportion is generally lower as ageDeath increases, but declines faster with age in controls. To analyze this more clearly, we create new models (interaction_lms) to visualize this effect. These models include new_study as a covariate, and age x diagnosis as an interactor.
```{r}
interaction_lms <- all_estimations_long %>%
  group_by(newStudy, cell_type) %>%
  do(tidy(lm(scale(rel_prop) ~ scale(RIN) + scale(ageDeath) + scale(PMI) +
               reportedGender + primaryDiagnosis + scale(ageDeath) * primaryDiagnosis, data = .))) %>%
  ungroup() %>%
  mutate(padj = p.adjust(`p.value`, method = 'fdr'),
         class = case_when(
           str_detect(cell_type, "Inh") ~ "Inhibitory",
           str_detect(cell_type, "Exc") ~ "Excitatory",
           TRUE ~ "Non-Neuronal"),
         term = recode(term,
                       `(Intercept)` = "Intercept",
                       `reportedGendermale` = "gender:Male",
                       `primaryDiagnosisSchizophrenia` = "SCZ",
                       `primaryDiagnosisBipolar Disorder` = "BP",
                       `scale(ageDeath):primaryDiagnosisSchizophrenia` = "Age x Diagnosis",
                       `scale(ageDeath)` = "Age",
                       `scale(PMI..in.hours.)` = "PMI",
                       `scale(RIN)` = "RIN")) %>%
  merge(unique(all_estimations_long[c('dataset', 'newStudy')]), by.x = "newStudy")

```

Meganalysis w/ all data 
```{r}
mega_lms <- all_estimations_long %>%  filter(primaryDiagnosis %in% c('Schizophrenia', "control")) %>%
  group_by(cell_type) %>%
  do(tidy(lm(scale(rel_prop) ~ scale(RIN) + scale(ageDeath) + scale(PMI) +
             reportedGender + primaryDiagnosis + newStudy + scale(ageDeath) * primaryDiagnosis, data = .))) %>%
  ungroup() %>% 
  mutate(padj = p.adjust(`p.value`, method = 'fdr')) %>%
  mutate(class = case_when(
    str_detect(cell_type, "Inh") ~ "Inhibitory",
    str_detect(cell_type, "Exc") ~ "Excitatory",
    TRUE ~ "Non-Neuronal")) %>%
  mutate(term = recode(term,
                       `(Intercept)` = "Intercept",
                       `reportedGendermale` = "gender:Male",
                       `primaryDiagnosisSchizophrenia` = "SCZ",
                       `primaryDiagnosisBipolar Disorder` = "BP",
                       `DxMDD` = "MDD",
                       `scale(ageDeath)` = "Age",
                       `scale(ageDeath):primaryDiagnosisSchizophrenia` = "Age x Diagnosis",
                       `scale(PMI)` = "PMI", 
                       `newStudyNIMH_HBCC` = "NIMH_HBCC",
                       `newStudyLIBD_szControl` = "LIBD_szControl",
                       `newStudyPitt` = "Pitt",
                       `newStudyMSSM` = "MSSM",
                       `newStudyPenn` = "Penn",
                       `scale(RIN)` = "RIN"))
write.csv(x = mega_lms, file = "/external/rprshnas01/kcni/dkiss/cell_prop_psychiatry/data/psychencode_MGP_models_mega")
```


Create age groups from age 20-90 in increments of 10 years. Plot meganalysis beta coefs against age group.
```{r}
# Create function to map age to age range
age_to_range <- function(age) {
  lower_bound <- floor(age/10) * 10
  upper_bound <- lower_bound + 9
  paste0(lower_bound, "-", upper_bound)
}

all_estimations_long$age_range <- sapply(all_estimations_long$ageDeath, age_to_range)

mega_lms_by_age <- all_estimations_long %>% 
  group_by(age_range, cell_type) %>%
  do(tidy(lm(scale(rel_prop) ~ scale(RIN) + scale(PMI) +
             reportedGender + primaryDiagnosis + newStudy, data = .))) %>%
  ungroup() %>% 
  mutate(padj = p.adjust(`p.value`, method = 'fdr')) %>%
  mutate(class = case_when(
    str_detect(cell_type, "Inh") ~ "Inhibitory",
    str_detect(cell_type, "Exc") ~ "Excitatory",
    TRUE ~ "Non-Neuronal")) %>%
  mutate(term = recode(term,
                       `(Intercept)` = "Intercept",
                       `reportedGendermale` = "gender:Male",
                       `primaryDiagnosisSchizophrenia` = "SCZ",
                       `primaryDiagnosisBipolar Disorder` = "BP",
                       `DxMDD` = "MDD",
                       `scale(ageDeath)` = "Age",
                       `scale(PMI)` = "PMI", 
                       `newStudyNIMH_HBCC` = "NIMH_HBCC",
                       `newStudyPitt` = "Pitt",
                       `newStudyMSSM` = "MSSM",
                       `newStudyPenn` = "Penn",
                       `scale(RIN)` = "RIN"))

```

Additional functions to  generate age range bins 
```{r}
# Create function to map age to age range based on 20% quantiles
age_to_range_quantile <- function(age) {
  quantiles = quantile(age, probs = seq(0.2, 1, 0.2))
  range_vec = c()
  for (i in 1:length(quantiles)) {
    if (i == 1) {
      range_vec[age <= quantiles[i]] <- paste0(0, "-", quantiles[i])
    } else {
      range_vec[age > quantiles[i-1] & age <= quantiles[i]] <- paste0(quantiles[i-1], "-", quantiles[i])
    }
  }
  range_vec
}
# Create function to bin ages to >=70 and <70
classify_ages <- function(ages) {
  classifications <- ifelse(ages <= 70, "Under 70", "Over 70")
  return(classifications)
}
```

Bulk RNAseq Meganalysis based on age +/- 70
```{r}
all_estimations_long$age_class <- sapply(all_estimations_long$ageDeath, classify_ages) %>% factor(levels = c("Under 70", "Over 70"))

mega_lms_by_age_class <- all_estimations_long %>% 
  group_by(age_class, cell_type) %>%
  do(tidy(lm(scale(rel_prop) ~ scale(RIN) + scale(PMI) +
             reportedGender + newStudy + primaryDiagnosis, data = .))) %>%
  ungroup() %>% 
  mutate(padj = p.adjust(`p.value`, method = 'fdr')) %>%
  mutate(class = case_when(
    str_detect(cell_type, "Inh") ~ "Inhibitory",
    str_detect(cell_type, "Exc") ~ "Excitatory",
    TRUE ~ "Non-Neuronal")) %>%
  mutate(term = recode(term,
                       `(Intercept)` = "Intercept",
                       `reportedGendermale` = "gender:Male",
                       `primaryDiagnosisSchizophrenia` = "SCZ",
                       `primaryDiagnosisBipolar Disorder` = "BP",
                       `scale(ageDeath)` = "Age",
                       `scale(PMI)` = "PMI", 
                       `newStudyNIMH_HBCC` = "NIMH_HBCC",
                       `newStudyPitt` = "Pitt",
                       `newStudyMSSM` = "MSSM",
                       `newStudyPenn` = "Penn",
                       `scale(RIN)` = "RIN"))
```

Single Cell Meganalysis with interaction model
```{r}
snCTPs_long <- psychencode_snCTPs %>%
  pivot_longer(cols = Astrocyte:VIP, names_to = 'cell_type', values_to = 'rel_prop',)
snCTPs_long$age_class <- snCTPs_long$ageOfDeath %>% classify_ages() %>% factor()

ss_mega_lms <- snCTPs_long %>% filter(total_cell_counts >= 500) %>%
  group_by(cell_type) %>%
  do(tidy(lm(scale(rel_prop) ~ scale(PMI) + Sex + Institution + Phenotype + ageOfDeath * Phenotype, data = .))) %>%
  ungroup() %>%
  mutate(padj = p.adjust(`p.value`, method = 'fdr')) %>%
  # add cell class labels
  mutate(class = case_when(
    cell_type %in% c("SST", "VIP", "PVALB", "LAMP5") ~ "Inhibitory",
    cell_type == "Excitatory" ~ "Excitatory",
    TRUE ~ "Non-Neuronal")) %>%
  mutate(term = recode(term,
                       `(Intercept)` = "Intercept",
                       `reportedGendermale` = "gender:Male",
                       `PhenotypeSZ` = "SCZ",
                       `primaryDiagnosisBipolar Disorder` = "BP",
                       `DxMDD` = "MDD",
                       `scale(ageDeath)` = "Age",
                       `scale(PMI)` = "PMI", 
                       `newStudyNIMH_HBCC` = "NIMH_HBCC",
                       `newStudyPitt` = "Pitt",
                       `newStudyMSSM` = "MSSM",
                       `newStudyPenn` = "Penn",
                       `scale(RIN)` = "RIN",
                       `PhenotypeSZ:ageOfDeath` = "Interaction"
))

```


Single Cell Meganalysis based on age +/- 70
```{r}
ss_mega_lms_by_age <- snCTPs_long %>% filter(total_cell_counts >= 500) %>%
  group_by(cell_type, age_class) %>%
  do(tidy(lm(scale(rel_prop) ~ scale(PMI) + Sex + Institution + Phenotype, data = .))) %>%
  ungroup() %>%
  mutate(padj = p.adjust(`p.value`, method = 'fdr')) %>%
  mutate(term = recode(term,
                       `(Intercept)` = "Intercept",
                       `reportedGendermale` = "gender:Male",
                       `PhenotypeSZ` = "SCZ",
                       `primaryDiagnosisBipolar Disorder` = "BP",
                       `DxMDD` = "MDD",
                       `scale(ageDeath)` = "Age",
                       `scale(PMI)` = "PMI", 
                       `newStudyNIMH_HBCC` = "NIMH_HBCC",
                       `newStudyPitt` = "Pitt",
                       `newStudyMSSM` = "MSSM",
                       `newStudyPenn` = "Penn",
                       `scale(RIN)` = "RIN"))

```

Create a table of mean cohort ages, stratified by diagnosis
```{r}
#Adding cohort ages - stratified by diagnosis
mean_ageDeath = all_estimations_long %>%
    filter(primaryDiagnosis %in% c("control", "Schizophrenia")) %>%
    group_by(newStudy, primaryDiagnosis) %>%
    summarize(mean_ageDeath = mean(ageDeath, na.rm = TRUE)) %>%
  rename(
    Cohort = newStudy,
    Diagnosis = primaryDiagnosis,
    `Mean ageDeath` = mean_ageDeath) %>%
  mutate(Cohort = factor(Cohort, levels = c("Pitt", "GVEX", "NIMH_HBCC", "LIBD_szControl", "MSSM", "Penn"))) %>%
  arrange(Cohort) %>% as.data.frame()
mean_ageDeath$Diagnosis <- recode(mean_ageDeath$Diagnosis,
                                   "control" = "CON",
                                   "Schizophrenia" = "SCZ")
mean_ageDeath$`Mean ageDeath` <- format(round(mean_ageDeath$`Mean ageDeath`, 1), nsmall = 1)
```


------------////FIGURES////------------

Figure 1: Illustrating the association between cell prop and diagnosis and cohort specific differences
```{r, fig.height=13, fig.width=11 }
# Figure 1a: Results from SCZ meganalysis stratified by cell class
significant_mega <- subset(mega_lms, padj <= 0.05 & term == "SCZ")
significant_mega$asterisks <- ifelse(significant_mega$padj <= 0.001, "***",
                                   ifelse(significant_mega$padj <= 0.01, "**", "*"))
significant_mega$vjust <- ifelse(significant_mega$estimate >= 0, -3, 3.5)

figure_1a <- mega_lms %>% 
  filter(term %in% 'SCZ') %>% 
  ggplot(aes(x = cell_type, y = estimate)) + 
  geom_hline(yintercept = 0) + 
  geom_bar(stat = "identity", position = "dodge") + 
  facet_grid(~class, drop = T, scale = "free_x", space = "free") +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) + 
  ylab('Beta Coefficient') + 
  xlab('Cell Type') + 
  geom_text(data = significant_mega,
            aes(cell_type, estimate, label = asterisks), 
            vjust = significant_mega$vjust) +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 13), 
    axis.title.x = element_text(vjust = 6, size = 16),
    axis.title.y = element_text(size = 16),
    strip.text.x = element_text(size = 16)) +
  guides(fill = FALSE) +
  scale_y_continuous(limits = c(-0.25, 0.42))

# Figure 1b: Cohort-specific beta values in SST, PVALB, VIP(?)
# Add meganalysis data to combined_lms
#mega <- mega_lms %>% filter(term == 'SCZ', cell_type %in% c("Inh_SST", "Inh_PVALB", "Inh_VIP"))
# mega$newStudy <- rep("All", nrow(mega))
# mega$dataset <- rep("All", nrow(mega))
# combined_lms <- rbind(combined_lms, mega)
# combined_lms$newStudy <- combined_lms$newStudy %>% factor(levels = c("Pitt", "GVEX", "NIMH_HBCC", "LIBD_szControl", "MSSM", "Penn", "All"))

significant_combined <- subset(combined_lms, padj < 0.1 & cell_type %in% c("Inh_SST", "Inh_PVALB", "Inh_VIP") & term == "SCZ")
significant_combined$asterisks <- ifelse(significant_combined$padj <= 0.01, "***",
                                         ifelse(significant_combined$padj <= 0.05, "**", "*"))
significant_combined$vjust <- ifelse(significant_combined$estimate >= 0, -3, 6)

figure_1b <- combined_lms %>% 
  filter(term == 'SCZ', cell_type %in% c("Inh_SST", "Inh_PVALB", "Inh_VIP")) %>% 
  mutate(cell_type = fct_reorder(cell_type, estimate)) %>% 
  ggplot(aes(x = newStudy, y = estimate, fill = newStudy)) + 
  geom_hline(yintercept = 0) + 
  geom_bar(stat = "identity", position = "dodge") + 
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) + 
  ylab('Beta Coefficient') + 
  xlab('') +
  scale_fill_manual(values = cbPalette) +
  geom_text(data = significant_combined,
            aes(newStudy, estimate, label = asterisks), 
            vjust = significant_combined$vjust) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(vjust = 6, size = 15),
    axis.title.y = element_text(size = 16),
    strip.text.x = element_text(size = 14),
    axis.line.x = element_blank(), 
    axis.ticks.x = element_blank()) +
  facet_grid(~cell_type, drop = T, scale = "free_x", space = "free") +
  guides(fill = guide_none()) +
  scale_y_continuous(limits = c(-1, 0.7))


# Figure 1c: Raw MGPs vs. Diagnosis
figure_1c <- all_estimations_long %>%
  filter(primaryDiagnosis %in% c('Schizophrenia', "control"), cell_type %in% c("Inh_SST", "Inh_PVALB", "Inh_VIP")) %>%
  ggplot(aes(x = primaryDiagnosis, y = rel_prop)) +
  geom_boxplot(outlier.shape = NA, aes(fill = newStudy, alpha = 0.5), show.legend = F, notch = T) +
  geom_beeswarm(size = 1, alpha = 0.3, aes(colour = newStudy), show.legend = F) +
  ylab('Relative Cell Prop.') + 
  xlab('Diagnosis') + 
  scale_x_discrete(labels = c("C", "SCZ")) +
  scale_colour_manual(values = cbPalette) +
  scale_fill_manual(values = cbPalette) +
  theme(
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(vjust = -2, size = 15),
    axis.title.y = element_text(size = 15),
    strip.text.x = element_text(size = 14),
    strip.text.y = element_text(size = 14)) +
  guides(fill = FALSE) +
  facet_grid(rows = vars(cell_type), cols = vars(newStudy), drop = T, scale = "free", switch = "y", space = "free") +
  geom_signif(comparisons = list(c("control", "Schizophrenia")), map_signif_level = TRUE, , test = wilcox.test) +
  scale_y_continuous(limits = c(-3.5, 3.5)) 

#Figure 1d - Hisotgram of cohort ages
figure_1d = all_estimations %>%
    ggplot(aes(x = ageDeath)) +
    geom_histogram(aes(fill = newStudy)) +
    facet_wrap(~ newStudy, nrow = 6, scales = "free_y") +
    labs(x = "ageDeath", y = "Frequency") +
    scale_fill_manual(values = c("#56B4E9", "#009E73","#E69F00", "#0072B2", "#D55E00", "#CC79A7")) + 
  scale_y_continuous(n.breaks = 4) +
  guides(fill = guide_none()) + 
  theme(panel.grid = element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(size = rel(0.9), face = "plain"),
    axis.text.x = element_text(size = 13),
    axis.text.y = element_text(size = 13),
    axis.title.x = element_text( size = 15),
    axis.title.y = element_text(size = 16),
    strip.text.x = element_text(size = 14))

# Combine Figure 1
figure_1_top = (figure_1b | figure_1d) + plot_layout(widths = c(4,2))
figure_1_bottom = figure_1c
  
figure_1 = figure_1_top / figure_1_bottom + plot_annotation(tag_levels = 'A') + plot_layout(heights = c(1, 1)) & theme(plot.tag = element_text(size = 25))
figure_1

#Save to plots folder
output_filename <- "~/cell_prop_psychiatry/plots/figure_1.jpg"

# Use ggsave to save the plot as a JPG image
ggsave(output_filename, figure_1, width = 11, height = 13, dpi = 200)

```

Figure 2: Introducing and presenting an interaction between age and diagnosis w/rt cell proportion.
```{r, fig.height=13, fig.width=13}
# Plot interaction beta values from meganalysis
significant_mega = subset(mega_lms, padj <= 0.1 & term == "Age x Diagnosis")
significant_mega$asterisks = ifelse(significant_mega$padj <= 0.01, "***",
                                   ifelse(significant_mega$padj <= 0.05, "**", "*"))
significant_mega$vjust = ifelse(significant_mega$estimate >= 0, -3, 3)

# Figure 2a: Results from interaction meganalysis stratified by cell class - plot interaction beta coeff
figure_2a = mega_lms %>% 
  filter(term %in% 'Age x Diagnosis') %>% 
  ggplot(aes(x = cell_type, y = estimate)) + 
  geom_hline(yintercept = 0) + 
  geom_bar(stat = "identity", position = "dodge") + 
  facet_grid(~class, drop = T, scale = "free_x", space = "free") +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) + 
  ylab('Interaction Coefficient') + 
  xlab('Cell Type') + 
  geom_text(data = significant_mega,
            aes(cell_type, estimate, label = asterisks), 
            vjust = significant_mega$vjust) +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 12), 
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(vjust = 8, size = 15),
    axis.title.y = element_text(size = 15),
    strip.text.x = element_text(size = 14)) +
  guides(fill = FALSE) +
  scale_y_continuous(limits = c(-0.15, 0.32))

# Figure 2b: Plot beta values from meganalysis in 10-year age bins for SST, PVALB, VIP
significant_mega_age = subset(mega_lms_by_age, padj <= 0.1 & term == "SCZ" & cell_type %in% c("Inh_SST", "Inh_PVALB", "Inh_VIP"))
significant_mega_age$asterisks = ifelse(significant_mega_age$padj <= 0.01, "***",
                                         ifelse(significant_mega_age$padj <= 0.05, "**", "*"))
significant_mega_age$vjust = ifelse(significant_mega_age$estimate >= 0, -3, 3)

figure_2b = mega_lms_by_age %>% 
  filter(term %in% 'SCZ' & cell_type %in% c("Inh_SST", "Inh_PVALB", "Inh_VIP")) %>% 
  mutate(cell_type = fct_reorder(cell_type, estimate)) %>% 
  ggplot(aes(x = age_range, y = estimate)) + 
  geom_hline(yintercept = 0) + 
  geom_bar(stat = "identity", position = "dodge") + 
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) + 
  ylab('Beta Coefficient') + 
  xlab('\n \n Age Range') + 
  geom_text(data = significant_mega_age,
            aes(age_range, estimate, label = asterisks), 
            vjust = significant_mega_age$vjust) +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 13), 
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(vjust = 8, size = 15),
    axis.title.y = element_text(size = 15),
    strip.text.x = element_text(size = 14)) +
  facet_wrap(~cell_type, drop = T, scale = "free_x") +
  guides(fill = FALSE) +
  scale_y_continuous(limits = c(-1.0, 1.4))

# Add residuals to all_estimations_long
res_model <- lm(scale(rel_prop) ~ scale(RIN) + scale(PMI) + reportedGender, data = all_estimations_long)
all_estimations_long <- all_estimations_long %>% add_residuals(var = "resid", model = res_model)

# Figure 2c: Visualizing interaction between age and diagnosis by plotting rel_prop vs. age in each diagnosis 
figure_2c <- all_estimations_long %>%
  filter(primaryDiagnosis %in% c('Schizophrenia', "control"), cell_type %in% c("Inh_SST", "Inh_PVALB", "Inh_VIP"), ageDeath < 90) %>%
  ggplot(aes(x = ageDeath, y = rel_prop, color = primaryDiagnosis)) +
  geom_point(alpha = 0.5, size = 0.5) + 
  geom_smooth(se = F, method = 'lm', fullrange = T) +
  ylab('Relative Cell Prop.') + 
  xlab('Age') + 
  theme(
    axis.text.x = element_text(size = 15),
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(vjust = -2, size = 15),
    axis.title.y = element_text(size = 15),
    legend.position = c(0.9, 0.9),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),  
    strip.text.x = element_text(size = 14)) +
  facet_grid(~cell_type, drop = T, scale = "free_x", space = "free") +
  guides(fill = guide_legend(nrow = 1)) +
  scale_y_continuous(limits = c(-3, 3)) + 
  scale_color_manual(values = c("dodgerblue2", "firebrick2"), labels=c('CON', 'SCZ'))

#Figure 2d: Mega-analysis results when binned as +/- 70 years
significant_mega_age_class = subset(mega_lms_by_age_class, padj <= 0.1 & term == "SCZ" & cell_type %in% c("Inh_SST", "Inh_PVALB", "Inh_VIP"))
significant_mega_age_class$asterisks = ifelse(significant_mega_age_class$padj <= 0.01, "***", ifelse(significant_mega_age_class$padj <= 0.05, "**", "*"))
significant_mega_age_class$vjust = ifelse(significant_mega_age_class$estimate >= 0, -2, 3)

figure_2d = mega_lms_by_age_class %>% 
  filter(term %in% 'SCZ' & cell_type %in% c("Inh_SST", "Inh_PVALB", "Inh_VIP")) %>% 
  mutate(cell_type = fct_reorder(cell_type, estimate)) %>% 
  ggplot(aes(x = age_class, y = estimate)) + 
  geom_hline(yintercept = 0) + 
  geom_bar(stat = "identity", position = "dodge") + 
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) + 
  ylab('Beta Coefficient') + 
  xlab('\n \n Age Range') + 
  geom_text(data = significant_mega_age_class,
            aes(age_class, estimate, label = asterisks), 
            vjust = significant_mega_age_class$vjust) +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 13), 
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(vjust = 8, size = 15),
    axis.title.y = element_text(size = 15),
    strip.text.x = element_text(size = 14)) +
  facet_wrap(~cell_type, drop = T, scale = "free_x") +
  guides(fill = FALSE) +
  scale_y_continuous(limits = c(-1.0, 1.4))

figure_2_top = (figure_2b +figure_2d) + plot_layout(widths = c(2,1))
figure_2 = figure_2_top / figure_2c / figure_2a
figure_2 = figure_2 + plot_annotation(tag_levels = 'A') + plot_layout(heights = c(1, 1, 1)) & theme(plot.tag = element_text(size = 25))
figure_2

#Save to plots folder
output_filename <- "~/cell_prop_psychiatry/plots/figure_2.jpg"

# Use ggsave to save the plot as a JPG image
ggsave(output_filename, figure_2, width = 13, height = 15, dpi = 200)

```

Figure 3: Validating trends and interactions in ssRNAseq 
```{r, fig.height= 13, fig.width=10}
# Figure 3a: ssRNAseq cell proportions binned by age
significant_ss_mega_by_age <- subset(ss_mega_lms_by_age, padj <= 0.1 & term == "SCZ" & cell_type %in% c("SST", "PVALB", "VIP"))
significant_ss_mega_by_age$asterisks <- ifelse(significant_ss_mega_by_age$padj <= 0.01, "***",
                                         ifelse(significant_ss_mega_by_age$padj <= 0.05, "**", "*"))
significant_ss_mega_by_age$vjust <- ifelse(significant_ss_mega_by_age$estimate >= 0, -4, 4)

figure_3a <- ss_mega_lms_by_age %>% 
  filter(term %in% 'SCZ' & cell_type %in% c("SST", "PVALB", "VIP")) %>% 
  mutate(cell_type = fct_reorder(cell_type, estimate)) %>% 
  ggplot(aes(x = age_class, y = estimate)) + 
  geom_hline(yintercept = 0) + 
  geom_bar(stat = "identity", position = "dodge") + 
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) + 
  ylab('Beta Coefficient') + 
  xlab('Age Range (Above/Below 70)') + 
  geom_text(data = significant_ss_mega_by_age,
            aes(age_class, estimate, label = asterisks), 
            vjust = significant_ss_mega_by_age$vjust) +
  theme(
    axis.text.x = element_text(size = 13),
    axis.text.y = element_text(size = 13),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 12), 
    strip.text.x = element_text(size = 15)
  ) +
  scale_y_continuous(limits = c(-1.4, 1.4)) +
  facet_wrap(~cell_type, drop = T, scale = "free")

# Figure 3b: Relative cell proportions from snCTPs
figure_3b <- snCTPs_long %>% filter(total_cell_counts >= 500) %>%
  filter(Phenotype %in% c('SZ', "CON"), cell_type %in% c("SST", "PVALB", "VIP")) %>%
  ggplot(aes(x = ageOfDeath, y = rel_prop, color = Phenotype)) +
  geom_point(alpha = 0.8, size = 1.3) + 
  geom_smooth(se = F, method = 'lm', fullrange = T) +
  scale_colour_hue(labels = c("Control", "SCZ")) +
  ylab('Relative Cell Prop.') + 
  xlab('Age') + 
  theme(
    axis.text.x = element_text(size = 13),
    axis.text.y = element_text(size = 13),
    axis.title.x = element_text(vjust = -2, size = 16),
    axis.title.y = element_text(size = 16),
    legend.position = "bottom",
    legend.title = element_blank(),
    legend.text = element_text(size = 12), 
    strip.text.x = element_text(size = 15),
    strip.text.y = element_text(size = 15)
  ) +
  facet_rep_grid(rows = vars(cell_type),
    cols = vars(dataset),
    drop = T,
    scale = "free",
    switch = "y",
    space = "free_x",
    repeat.tick.labels = T
  ) +
  guides(fill = guide_legend(nrow = 1)) + 
  scale_color_manual(values = c("dodgerblue2", "firebrick2"), labels=c('CON', 'SCZ'))

# Figure 3c: Interaction terms for snRNAseq results
significant_ss_mega <- subset(ss_mega_lms, padj <= 0.1 & term == "Interaction" & cell_type %in% c("SST", "PVALB", "VIP"))
significant_ss_mega$asterisks <- ifelse(significant_ss_mega$padj <= 0.01, "***",
                                         ifelse(significant_ss_mega$padj <= 0.05, "**", "*"))
significant_ss_mega$vjust <- ifelse(significant_ss_mega$estimate >= 0, -2, 2)

figure_3c = ss_mega_lms %>% 
  filter(term %in% 'Interaction') %>% 
  ggplot(aes(x = cell_type, y = estimate)) + 
  geom_hline(yintercept = 0) + 
  geom_bar(stat = "identity", position = "dodge") +
  geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error)) + 
    facet_grid(~class, drop = T, scale = "free_x", space = "free") +
  ylab('Interaction Coefficient') + 
  xlab('Cell Type') + 
  geom_text(data = significant_ss_mega,
            aes(cell_type, estimate, label = asterisks), 
            vjust = significant_ss_mega$vjust) +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1, size = 12), 
    axis.text.y = element_text(size = 15),
    axis.title.x = element_text(vjust = 8, size = 15),
    axis.title.y = element_text(size = 15),
    strip.text.x = element_text(size = 15)) +
  guides(fill = FALSE) +
  scale_y_continuous(limits = c(-0.05, 0.05))


# Figure 3: Combined figure
figure_3 <- figure_3a / figure_3b /figure_3c
figure_3 = figure_3 + plot_annotation(tag_levels = 'A') + plot_layout(heights = c(1, 1.6, 1)) & theme(plot.tag = element_text(size = 25))
figure_3

#Save to plots folder
output_filename <- "~/cell_prop_psychiatry/plots/figure_3.jpg"

# Use ggsave to save the plot as a JPG image
ggsave(output_filename, figure_3, width = 12, height = 13, dpi = 200)

```



